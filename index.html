<!DOCTYPE html><html lang="de"><head>    <meta charset="UTF-8">    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">    <title>Profi-R√ºstplan | KI-Deep-Analysis Fix</title>        <script src="https://cdn.tailwindcss.com"></script>    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>        :root { --bg-main: #0f172a; --bg-sidebar: #1e293b; --accent: #3b82f6; }        body { background-color: var(--bg-main); color: #f1f5f9; margin: 0; padding: 0; overflow: hidden; font-family: ui-sans-serif, system-ui, sans-serif; height: 100vh; width: 100vw; }        .app-container { display: flex; height: 100vh; width: 100vw; overflow: hidden; }                aside { width: 320px; background-color: var(--bg-sidebar); border-right: 1px solid #334155; display: flex; flex-direction: column; flex-shrink: 0; transition: all 0.3s ease; position: relative; z-index: 50; }        aside.collapsed { width: 60px; }        aside.collapsed .sidebar-content { display: none; }        .toggle-btn { position: absolute; right: -12px; top: 20px; cursor: pointer; background: #3b82f6; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; z-index: 60; border: 2px solid #0f172a; }                main { flex-grow: 1; display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem; padding: 1rem; overflow-y: auto; overflow-x: auto; }        @media (max-width: 1200px) { main { grid-template-columns: repeat(3, 1fr); } }        @media (max-width: 768px) { main { grid-template-columns: repeat(2, 1fr); padding-top: 60px; } aside { position: fixed; left: 0; transform: translateX(-100%); height: 100%; } aside.mobile-open { transform: translateX(0); width: 280px; } }
        .status-eingeplant { background-color: #064e3b; border-left: 4px solid #10b981; } /* Gr√ºn als Standard wie im Bild */        .status-umbau { background-color: #1e3a8a; border-left: 4px solid #3b82f6; }        .status-erledigt { background-color: #064e3b; border-left: 4px solid #10b981; }        .status-stoerung { background-color: #7f1d1d; border-left: 4px solid #ef4444; }
        .machine-badge { min-height: 38px; margin-bottom: 4px; display: flex; align-items: center; gap: 4px; padding: 4px 8px; border-radius: 6px; font-weight: 600; font-size: 11px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); width: 100%; }        .staff-header { font-size: 10px; font-weight: 800; color: #94a3b8; text-transform: uppercase; margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center; }        .note-area-inline { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: white; font-size: 9px; padding: 2px; width: 100%; height: 24px; resize: none; margin-top: 4px; }        .admin-input { background: #0f172a; border: 1px solid #334155; border-radius: 6px; padding: 6px; font-size: 11px; color: white; width: 100%; outline: none; }        .btn-paste { animation: pulse 1.5s infinite; color: #10b981; cursor: pointer; font-size: 9px; font-weight: bold; background: rgba(16,185,129,0.1); padding: 2px 5px; border-radius: 4px; border: 1px solid #10b981; }        @keyframes pulse { 0%, 100% { opacity: 0.7; } 50% { opacity: 1; } }        #statsModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(10px); padding: 20px; }        details summary { list-style: none; cursor: pointer; outline: none; }    </style></head>
<body>
    <button class="md:hidden fixed top-4 left-4 z-[100] bg-slate-800 p-2 rounded" onclick="toggleMobileSidebar()">‚ò∞</button>

    <div id="statsModal">        <div class="bg-slate-900 p-8 rounded-3xl w-full max-w-4xl max-h-[90vh] overflow-y-auto border border-blue-500/30">            <div class="flex justify-between items-center mb-6">                <h2 class="text-2xl font-black text-blue-400 italic uppercase">ü§ñ Deep Analysis 2.2</h2>                <button onclick="closeStats()" class="text-3xl">√ó</button>            </div>            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">                <input type="number" id="statsFrom" class="admin-input" placeholder="Start KW">                <input type="number" id="statsTo" class="admin-input" placeholder="Ende KW">                <button onclick="runExtendedAIAnalysis()" class="bg-blue-600 rounded-xl font-bold uppercase text-xs p-2">Analyse Starten</button>            </div>            <div id="aiAnalysisContent" class="space-y-6"></div>        </div>    </div>

    <div class="app-container">        <aside id="sidebar">            <div class="toggle-btn" onclick="toggleSidebar()" id="sidebarBtn">¬´</div>            <div class="sidebar-content p-4 flex flex-col h-full overflow-y-auto">                <h2 class="text-xl font-black italic mb-6 border-b border-slate-700 pb-2">R√úSTPLAN LIVE</h2>                
                <details open class="mb-4">                    <summary class="text-[10px] font-black text-blue-400 uppercase mb-2 flex justify-between"><span>‚öôÔ∏è KI & System</span><span>‚ñº</span></summary>                    <div class="space-y-2">                        <button onclick="openStats()" class="w-full bg-indigo-600 py-2 rounded-lg font-bold text-xs uppercase">KI-Analyse</button>                        <button id="lockBtn" class="w-full bg-emerald-600 py-2 rounded-lg font-bold text-xs uppercase">üîì Offen</button>                    </div>                </details>

                <details open class="mb-4">                    <summary class="text-[10px] font-black text-blue-400 uppercase mb-2 flex justify-between"><span>üìÖ Kalender</span><span>‚ñº</span></summary>                    <div class="bg-slate-800 p-3 rounded-xl flex items-center justify-between font-black">                        <button onclick="changeWeek(-1)">‚óÄ</button>                        <span id="weekDisplay" class="text-blue-400">KW --</span>                        <button onclick="changeWeek(1)">‚ñ∂</button>                    </div>                </details>

                <details open class="mb-4">                    <summary class="text-[10px] font-black text-blue-400 uppercase mb-2 flex justify-between"><span>üë• Personal</span><span>‚ñº</span></summary>                    <div id="staffList" class="flex flex-wrap gap-1 mt-2"></div>                </details>

                <details open class="mb-4">                    <summary class="text-[10px] font-black text-blue-400 uppercase mb-2 flex justify-between"><span>üõ†Ô∏è Maschinen</span><span>‚ñº</span></summary>                    <div id="pool" class="grid grid-cols-2 gap-1 mt-2"></div>                </details>            </div>        </aside>
        <main id="mainGrid"></main>    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyAmT1v__I-e0dfRLicdG9SN4uNt4lEKezA", authDomain: "test-dee17.firebaseapp.com", databaseURL: "https://test-dee17-default-rtdb.europe-west1.firebasedatabase.app", projectId: "test-dee17", storageBucket: "test-dee17.firebasestorage.app", messagingSenderId: "1010731540568", appId: "1:1010731540568:web:1a32e27dd3aba0130fea2d" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const days = ["Montag", "Dienstag", "Mittwoch", "Donnerstag", "Freitag"];
        let staff = [], machines = [], plan = {}, currentYear, currentWeek, clipboard = null;

        function initApp() {
            const now = new Date(); currentYear = now.getFullYear(); currentWeek = getWeek(now);
            listenToDatabase();
        }

        function listenToDatabase() {
            // WICHTIG: Den gesamten Node laden, damit keine Daten verloren gehen
            db.ref('rustplan_root').on('value', (snapshot) => {
                const data = snapshot.val() || {};
                staff = data.staff || ["LANGE", "SARIC", "OKS", "EDERLE"];
                machines = data.machines || [];
                
                // Pr√§zises Laden der Woche
                const weekKey = `plan-${currentYear}-W${currentWeek}`;
                plan = data[weekKey] || {};
                
                document.getElementById('weekDisplay').innerText = `KW ${currentWeek}`;
                render();
            });
        }

        function render() {
            const main = document.getElementById('mainGrid'); main.innerHTML = '';
            const todayName = new Intl.DateTimeFormat('de-DE', { weekday: 'long' }).format(new Date());

            days.forEach(day => {
                const col = document.createElement('div');
                col.className = `flex flex-col gap-2`;
                col.innerHTML = `<div class="p-2 text-center font-black text-[10px] uppercase rounded bg-slate-800 ${day===todayName ? 'border border-blue-500 text-blue-400' : 'text-slate-500'}">${day}</div>`;
                
                staff.forEach(person => {
                    const key = `${day}-${person}`;
                    const slot = document.createElement('div');
                    slot.className = `bg-slate-900/40 p-2 rounded-xl border border-slate-800/50 min-h-[100px]`;
                    slot.setAttribute('ondrop', 'drop(event)'); slot.setAttribute('ondragover', 'event.preventDefault()');
                    slot.setAttribute('data-key', key);
                    
                    const pasteBtn = clipboard ? `<button onclick="pasteToSlot('${key}')" class="btn-paste">üìã EINF√úGEN</button>` : '';
                    slot.innerHTML = `<div class="staff-header"><span>${person}</span>${pasteBtn}</div><div id="${key}_list"></div>`;
                    col.appendChild(slot);
                });
                main.appendChild(col);
            });
            draw();
            renderAdminLists();
        }

        function draw() {
            Object.keys(plan).forEach(key => {
                const listContainer = document.getElementById(key + '_list');
                if (!listContainer) return;
                listContainer.innerHTML = '';
                
                const entries = plan[key];
                if (!entries) return;

                // Konvertiere Objekt zu Array falls Firebase es falsch formatiert hat
                const entriesArray = Array.isArray(entries) ? entries : Object.values(entries);

                entriesArray.forEach((m, i) => {
                    if(!m) return;
                    const b = document.createElement('div');
                    b.className = `machine-badge status-${m.status || 'eingeplant'}`;
                    b.innerHTML = `
                        <span class="flex-1 cursor-pointer truncate" onclick="toggleStatus('${key}', ${i})">${m.name}</span>
                        <div class="flex gap-2 items-center opacity-70">
                            <span onclick="copyToClipboard('${key}', ${i})" class="cursor-pointer">üìã</span>
                            <span onclick="toggleNote('${key}', ${i})" class="cursor-pointer ${m.note ? 'text-yellow-400' : ''}">üí¨</span>
                            <span onclick="remove('${key}', ${i})" class="text-rose-500 font-bold cursor-pointer">√ó</span>
                        </div>
                    `;
                    if(m.showNote) {
                        const txt = document.createElement('textarea');
                        txt.className = "note-area-inline"; txt.value = m.note || "";
                        txt.onchange = (e) => { 
                            if(!Array.isArray(plan[key])) plan[key] = Object.values(plan[key]);
                            plan[key][i].note = e.target.value; 
                            save(); 
                        };
                        b.appendChild(txt);
                    }
                    listContainer.appendChild(b);
                });
            });
        }

        function copyToClipboard(k, i) {
            const source = Array.isArray(plan[k]) ? plan[k][i] : Object.values(plan[k])[i];
            clipboard = JSON.parse(JSON.stringify(source));
            render();
        }

        function pasteToSlot(k) {
            if(!clipboard) return;
            if(!plan[k]) plan[k] = [];
            if(!Array.isArray(plan[k])) plan[k] = Object.values(plan[k]);
            plan[k].push(clipboard);
            clipboard = null; // Speicher leeren nach 1x Einf√ºgen
            save();
            render();
        }

        function toggleStatus(k, i) {
            if(!Array.isArray(plan[k])) plan[k] = Object.values(plan[k]);
            const states = ['eingeplant', 'umbau', 'erledigt', 'stoerung'];
            const current = plan[k][i].status || 'eingeplant';
            plan[k][i].status = states[(states.indexOf(current)+1)%4];
            save();
        }

        function remove(k, i) {
            if(!Array.isArray(plan[k])) plan[k] = Object.values(plan[k]);
            plan[k].splice(i, 1);
            save();
        }

        function save() {
            db.ref(`rustplan_root/plan-${currentYear}-W${currentWeek}`).set(plan);
        }

        function getWeek(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
            return Math.ceil((((d - new Date(Date.UTC(d.getUTCFullYear(),0,1))) / 86400000) + 1)/7);
        }

        function toggleNote(k, i) {
            if(!Array.isArray(plan[k])) plan[k] = Object.values(plan[k]);
            plan[k][i].showNote = !plan[k][i].showNote;
            save();
        }

        function changeWeek(v) { currentWeek += v; listenToDatabase(); }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('collapsed'); }
        function toggleMobileSidebar() { document.getElementById('sidebar').classList.toggle('mobile-open'); }
        function openStats() { document.getElementById('statsModal').style.display='flex'; }
        function closeStats() { document.getElementById('statsModal').style.display='none'; }

        function renderAdminLists() { 
            document.getElementById('staffList').innerHTML = staff.map(s => `<div class="bg-slate-800 px-2 py-1 rounded text-[9px] border border-slate-700 font-bold">${s}</div>`).join('');
            document.getElementById('pool').innerHTML = machines.map(m => `<div draggable="true" ondragstart="event.dataTransfer.setData('text', '${m}')" class="bg-slate-700 p-2 rounded text-[9px] cursor-move text-center">${m}</div>`).join('');
        }

        function drop(e) {
            e.preventDefault();
            const machineName = e.dataTransfer.getData("text");
            const key = e.currentTarget.dataset.key;
            if(!plan[key]) plan[key] = [];
            if(!Array.isArray(plan[key])) plan[key] = Object.values(plan[key]);
            plan[key].push({name: machineName, status: 'eingeplant'});
            save();
        }

        async function runExtendedAIAnalysis() {
            const from = parseInt(document.getElementById('statsFrom').value);
            const to = parseInt(document.getElementById('statsTo').value);
            const content = document.getElementById('aiAnalysisContent');
            content.innerHTML = `<div class="text-blue-400 animate-pulse">KI-Deep-Scan l√§uft...</div>`;
            
            const snap = await db.ref('rustplan_root').once('value');
            const data = snap.val() || {};
            let stats = { total: 0, erledigt: 0, fail: 0, staff: {}, days: {} };

            for(let w = from; w <= to; w++) {
                const wData = data[`plan-${currentYear}-W${w}`] || {};
                Object.entries(wData).forEach(([k, slots]) => {
                    const [tag, name] = k.split('-');
                    const arr = Array.isArray(slots) ? slots : Object.values(slots);
                    arr.forEach(m => {
                        stats.total++;
                        if(m.status === 'erledigt') { stats.erledigt++; stats.staff[name] = (stats.staff[name]||0)+1; }
                        if(m.status === 'stoerung') { stats.fail++; stats.days[tag] = (stats.days[tag]||0)+1; }
                    });
                });
            }

            content.innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-slate-800 p-4 rounded-xl border-l-4 border-blue-500">
                        <p class="text-[10px] uppercase font-bold text-slate-500">Total</p>
                        <p class="text-2xl font-black">${stats.total}</p>
                    </div>
                    <div class="bg-slate-800 p-4 rounded-xl border-l-4 border-emerald-500">
                        <p class="text-[10px] uppercase font-bold text-slate-500">Erledigt</p>
                        <p class="text-2xl font-black text-emerald-400">${stats.erledigt}</p>
                    </div>
                    <div class="bg-slate-800 p-4 rounded-xl border-l-4 border-rose-500">
                        <p class="text-[10px] uppercase font-bold text-slate-500">St√∂rungen</p>
                        <p class="text-2xl font-black text-rose-400">${stats.fail}</p>
                    </div>
                    <div class="bg-slate-800 p-4 rounded-xl border-l-4 border-amber-500">
                        <p class="text-[10px] uppercase font-bold text-slate-500">Effizienz</p>
                        <p class="text-2xl font-black">${stats.total ? Math.round(stats.erledigt/stats.total*100) : 0}%</p>
                    </div>
                </div>
                <div class="bg-blue-600/10 p-6 rounded-2xl border border-blue-500/20 text-sm">
                    <p class="text-blue-300 font-bold mb-2 uppercase tracking-widest">KI-Auswertung:</p>
                    Der kritischste Tag ist <b>${Object.entries(stats.days).sort((a,b)=>b[1]-a[1])[0]?.[0] || 'N/A'}</b>. 
                    Top-Performer im Zeitraum ist <b>${Object.entries(stats.staff).sort((a,b)=>b[1]-a[1])[0]?.[0] || 'N/A'}</b>.
                </div>`;
        }
        
        window.onload = initApp;
    </script>
</body></html>
